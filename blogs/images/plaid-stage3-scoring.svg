<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 740" font-family="'Segoe UI', Arial, sans-serif">
    <defs>
        <linearGradient id="bg3" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#f8f9fb"/>
            <stop offset="100%" stop-color="#eaecf0"/>
        </linearGradient>
        <filter id="sh3" x="-1%" y="-2%" width="102%" height="108%">
            <feDropShadow dx="0" dy="1" stdDeviation="2" flood-color="#00000010"/>
        </filter>
        <marker id="a3" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
            <path d="M0,0 L8,3 L0,6 Z" fill="#64748b"/>
        </marker>
        <marker id="a3p" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
            <path d="M0,0 L8,3 L0,6 Z" fill="#7c3aed"/>
        </marker>
    </defs>

    <rect width="900" height="740" rx="10" fill="url(#bg3)" stroke="#dee2e6" stroke-width="1"/>

    <!-- Title -->
    <text x="450" y="26" text-anchor="middle" font-size="16" font-weight="700" fill="#1e293b">PLAID Stage 3: Centroid Interaction Scoring</text>
    <text x="450" y="46" text-anchor="middle" font-size="11" fill="#94a3b8">Approximate MaxSim using only centroids — precomputed once, reused across all 50,000 candidates</text>

    <!-- ═══════════════════════════════════════════ -->
    <!-- STEP A: Precomputed Lookup Table              -->
    <!-- ═══════════════════════════════════════════ -->

    <rect x="20" y="62" width="860" height="195" rx="8" fill="#faf5ff" stroke="#c4b5fd" stroke-width="1.5" filter="url(#sh3)"/>
    <rect x="20" y="62" width="860" height="28" rx="8" fill="#7c3aed"/>
    <rect x="20" y="82" width="860" height="8" fill="#7c3aed"/>
    <text x="450" y="81" text-anchor="middle" font-size="12" font-weight="700" fill="#ffffff">Step A: Precompute Query ↔ Centroid Similarity Table (once per query)</text>

    <text x="40" y="108" font-size="10" fill="#475569">For each query token q and each centroid c in the codebook, compute cos(q, c). Store in a <tspan font-weight="700">32 × 65,536</tspan> lookup table.</text>
    <text x="40" y="124" font-size="10" fill="#475569">This table is computed <tspan font-weight="700" fill="#6b21a8">once</tspan> and reused for scoring all 50,000 candidates — the key to PLAID's efficiency.</text>

    <!-- Lookup table visualization -->
    <text x="40" y="148" font-size="10" font-weight="700" fill="#6b21a8">Lookup Table L[q, c] = cos(q, c):</text>

    <!-- Column headers (centroids) -->
    <g font-size="8" font-weight="700" fill="#166534">
        <rect x="130" y="154" width="56" height="18" rx="2" fill="#dcfce7" stroke="#86efac" stroke-width="0.5"/>
        <text x="158" y="167" text-anchor="middle">c₁₇₄₂₅</text>
        <rect x="190" y="154" width="52" height="18" rx="2" fill="#dcfce7" stroke="#86efac" stroke-width="0.5"/>
        <text x="216" y="167" text-anchor="middle">c₈₀₉₁</text>
        <rect x="246" y="154" width="56" height="18" rx="2" fill="#dcfce7" stroke="#86efac" stroke-width="0.5"/>
        <text x="274" y="167" text-anchor="middle">c₂₂₁₀₃</text>
        <rect x="306" y="154" width="56" height="18" rx="2" fill="#dcfce7" stroke="#86efac" stroke-width="0.5"/>
        <text x="334" y="167" text-anchor="middle">c₉₅₅₇</text>
        <rect x="366" y="154" width="60" height="18" rx="2" fill="#dcfce7" stroke="#86efac" stroke-width="0.5"/>
        <text x="396" y="167" text-anchor="middle">c₃₃₈₅₀</text>
        <text x="440" y="167" fill="#94a3b8">···</text>
        <rect x="460" y="154" width="60" height="18" rx="2" fill="#dcfce7" stroke="#86efac" stroke-width="0.5"/>
        <text x="490" y="167" text-anchor="middle">c₆₅₅₃₆</text>
    </g>

    <!-- Row headers (query tokens) + values -->
    <g font-size="8.5">
        <!-- q₁ row -->
        <rect x="40" y="176" width="84" height="18" rx="2" fill="#dbeafe" stroke="#93c5fd" stroke-width="0.5"/>
        <text x="82" y="189" text-anchor="middle" font-weight="700" fill="#1e40af">q₁ "amortize"</text>
        <rect x="130" y="176" width="56" height="18" rx="2" fill="#ede9fe" stroke="#c4b5fd" stroke-width="0.5"/>
        <text x="158" y="189" text-anchor="middle" font-weight="700" fill="#6b21a8">0.87</text>
        <rect x="190" y="176" width="52" height="18" rx="2" fill="#f5f3ff"/>
        <text x="216" y="189" text-anchor="middle" fill="#475569">0.22</text>
        <rect x="246" y="176" width="56" height="18" rx="2" fill="#f5f3ff"/>
        <text x="274" y="189" text-anchor="middle" fill="#475569">0.38</text>
        <rect x="306" y="176" width="56" height="18" rx="2" fill="#f5f3ff"/>
        <text x="334" y="189" text-anchor="middle" fill="#475569">0.15</text>
        <rect x="366" y="176" width="60" height="18" rx="2" fill="#f5f3ff"/>
        <text x="396" y="189" text-anchor="middle" fill="#475569">0.10</text>
        <text x="440" y="189" fill="#94a3b8">···</text>

        <!-- q₂ row -->
        <rect x="40" y="198" width="84" height="18" rx="2" fill="#dbeafe" stroke="#93c5fd" stroke-width="0.5"/>
        <text x="82" y="211" text-anchor="middle" font-weight="700" fill="#1e40af">q₂ "bond"</text>
        <rect x="130" y="198" width="56" height="18" rx="2" fill="#f5f3ff"/>
        <text x="158" y="211" text-anchor="middle" fill="#475569">0.31</text>
        <rect x="190" y="198" width="52" height="18" rx="2" fill="#ede9fe" stroke="#c4b5fd" stroke-width="0.5"/>
        <text x="216" y="211" text-anchor="middle" font-weight="700" fill="#6b21a8">0.79</text>
        <rect x="246" y="198" width="56" height="18" rx="2" fill="#f5f3ff"/>
        <text x="274" y="211" text-anchor="middle" fill="#475569">0.44</text>
        <rect x="306" y="198" width="56" height="18" rx="2" fill="#f5f3ff"/>
        <text x="334" y="211" text-anchor="middle" fill="#475569">0.52</text>
        <rect x="366" y="198" width="60" height="18" rx="2" fill="#f5f3ff"/>
        <text x="396" y="211" text-anchor="middle" fill="#475569">0.08</text>
        <text x="440" y="211" fill="#94a3b8">···</text>

        <!-- q₃ row -->
        <rect x="40" y="220" width="84" height="18" rx="2" fill="#dbeafe" stroke="#93c5fd" stroke-width="0.5"/>
        <text x="82" y="233" text-anchor="middle" font-weight="700" fill="#1e40af">q₃ "yield"</text>
        <rect x="130" y="220" width="56" height="18" rx="2" fill="#f5f3ff"/>
        <text x="158" y="233" text-anchor="middle" fill="#475569">0.42</text>
        <rect x="190" y="220" width="52" height="18" rx="2" fill="#f5f3ff"/>
        <text x="216" y="233" text-anchor="middle" fill="#475569">0.55</text>
        <rect x="246" y="220" width="56" height="18" rx="2" fill="#ede9fe" stroke="#c4b5fd" stroke-width="0.5"/>
        <text x="274" y="233" text-anchor="middle" font-weight="700" fill="#6b21a8">0.82</text>
        <rect x="306" y="220" width="56" height="18" rx="2" fill="#f5f3ff"/>
        <text x="334" y="233" text-anchor="middle" fill="#475569">0.41</text>
        <rect x="366" y="220" width="60" height="18" rx="2" fill="#f5f3ff"/>
        <text x="396" y="233" text-anchor="middle" fill="#475569">0.20</text>
        <text x="440" y="233" fill="#94a3b8">···</text>

        <!-- q₄ row / ... -->
        <rect x="40" y="240" width="84" height="14" rx="2" fill="#eff6ff"/>
        <text x="82" y="251" text-anchor="middle" fill="#94a3b8">q₄ … q₃₂</text>
        <text x="158" y="251" text-anchor="middle" fill="#94a3b8">···</text>
        <text x="216" y="251" text-anchor="middle" fill="#94a3b8">···</text>
        <text x="274" y="251" text-anchor="middle" fill="#94a3b8">···</text>
        <text x="334" y="251" text-anchor="middle" fill="#94a3b8">···</text>
        <text x="396" y="251" text-anchor="middle" fill="#94a3b8">···</text>
    </g>

    <!-- Cost annotation -->
    <rect x="560" y="178" width="310" height="66" rx="6" fill="#ffffff" stroke="#c4b5fd" stroke-width="1"/>
    <text x="715" y="196" text-anchor="middle" font-size="10" font-weight="700" fill="#6b21a8">Table size: 32 × 65,536 × 4 bytes = ~8 MB</text>
    <text x="715" y="214" text-anchor="middle" font-size="9" fill="#475569">Computed once per query via 32 vector lookups</text>
    <text x="715" y="230" text-anchor="middle" font-size="9" fill="#475569">against the codebook (already in RAM)</text>
    <text x="715" y="244" text-anchor="middle" font-size="9" font-weight="600" fill="#6b21a8">Reused for ALL 50,000 candidates</text>

    <!-- ═══════════════════════════════════════════ -->
    <!-- STEP B: Score one document                    -->
    <!-- ═══════════════════════════════════════════ -->

    <line x1="450" y1="257" x2="450" y2="273" stroke="#64748b" stroke-width="1.5" marker-end="url(#a3)"/>

    <rect x="20" y="279" width="860" height="208" rx="8" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5" filter="url(#sh3)"/>
    <rect x="20" y="279" width="860" height="28" rx="8" fill="#3b82f6"/>
    <rect x="20" y="299" width="860" height="8" fill="#3b82f6"/>
    <text x="450" y="298" text-anchor="middle" font-size="12" font-weight="700" fill="#ffffff">Step B: Approximate MaxSim for Document d₇ (using only surviving centroids + lookup table)</text>

    <text x="40" y="326" font-size="10" fill="#475569">d₇'s surviving centroids after Stage 2 pruning: {<tspan font-weight="600" fill="#166534">c₁₇₄₂₅</tspan>, <tspan font-weight="600" fill="#166534">c₈₀₉₁</tspan>, <tspan font-weight="600" fill="#166534">c₂₂₁₀₃</tspan>} (3 of 100 original centroids survived)</text>

    <text x="40" y="348" font-size="10" font-weight="700" fill="#1e40af">For each query token, find the max similarity to any surviving centroid (table lookups only — no computation):</text>

    <!-- Per-query-token max computation -->
    <g font-size="9">
        <!-- q₁ -->
        <rect x="40" y="358" width="820" height="26" rx="4" fill="#ffffff" stroke="#e2e8f0" stroke-width="1"/>
        <text x="56" y="375" font-weight="700" fill="#1e40af">q₁:</text>
        <text x="80" y="375" fill="#475569">max( L[q₁, c₁₇₄₂₅]=<tspan font-weight="700" fill="#6b21a8">0.87</tspan>,  L[q₁, c₈₀₉₁]=0.22,  L[q₁, c₂₂₁₀₃]=0.38 )</text>
        <text x="430" y="375" fill="#475569">=</text>
        <rect x="442" y="360" width="42" height="22" rx="3" fill="#ddd6fe" stroke="#8b5cf6" stroke-width="1.5"/>
        <text x="463" y="375" text-anchor="middle" font-weight="700" fill="#6b21a8">0.87</text>
        <text x="500" y="375" fill="#94a3b8">← best match is c₁₇₄₂₅ (financial terminology cluster)</text>

        <!-- q₂ -->
        <rect x="40" y="388" width="820" height="26" rx="4" fill="#ffffff" stroke="#e2e8f0" stroke-width="1"/>
        <text x="56" y="405" font-weight="700" fill="#1e40af">q₂:</text>
        <text x="80" y="405" fill="#475569">max( L[q₂, c₁₇₄₂₅]=0.31,  L[q₂, c₈₀₉₁]=<tspan font-weight="700" fill="#6b21a8">0.79</tspan>,  L[q₂, c₂₂₁₀₃]=0.44 )</text>
        <text x="430" y="405" fill="#475569">=</text>
        <rect x="442" y="390" width="42" height="22" rx="3" fill="#ddd6fe" stroke="#8b5cf6" stroke-width="1.5"/>
        <text x="463" y="405" text-anchor="middle" font-weight="700" fill="#6b21a8">0.79</text>
        <text x="500" y="405" fill="#94a3b8">← best match is c₈₀₉₁ (bond/debt instrument cluster)</text>

        <!-- q₃ -->
        <rect x="40" y="418" width="820" height="26" rx="4" fill="#ffffff" stroke="#e2e8f0" stroke-width="1"/>
        <text x="56" y="435" font-weight="700" fill="#1e40af">q₃:</text>
        <text x="80" y="435" fill="#475569">max( L[q₃, c₁₇₄₂₅]=0.42,  L[q₃, c₈₀₉₁]=0.55,  L[q₃, c₂₂₁₀₃]=<tspan font-weight="700" fill="#6b21a8">0.82</tspan> )</text>
        <text x="430" y="435" fill="#475569">=</text>
        <rect x="442" y="420" width="42" height="22" rx="3" fill="#ddd6fe" stroke="#8b5cf6" stroke-width="1.5"/>
        <text x="463" y="435" text-anchor="middle" font-weight="700" fill="#6b21a8">0.82</text>
        <text x="500" y="435" fill="#94a3b8">← best match is c₂₂₁₀₃ (yield/returns cluster)</text>

        <!-- q₄ ... q₃₂ -->
        <rect x="40" y="448" width="820" height="22" rx="4" fill="#f8fafc" stroke="#e2e8f0" stroke-width="0.5"/>
        <text x="56" y="463" font-weight="600" fill="#94a3b8">q₄ … q₃₂:</text>
        <text x="140" y="463" fill="#94a3b8">same process for remaining 29 query tokens → each contributes one max value</text>
    </g>

    <!-- Summation -->
    <rect x="40" y="474" width="500" height="6" fill="#3b82f6" rx="3" opacity="0.2"/>
    <text x="40" y="484" font-size="7" fill="#3b82f6">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</text>

    <!-- ═══════════════════════════════════════════ -->
    <!-- STEP C: Ranking across documents              -->
    <!-- ═══════════════════════════════════════════ -->

    <line x1="450" y1="487" x2="450" y2="503" stroke="#64748b" stroke-width="1.5" marker-end="url(#a3)"/>

    <rect x="20" y="509" width="860" height="222" rx="8" fill="#fefce8" stroke="#fbbf24" stroke-width="1.5" filter="url(#sh3)"/>
    <rect x="20" y="509" width="860" height="28" rx="8" fill="#d97706"/>
    <rect x="20" y="529" width="860" height="8" fill="#d97706"/>
    <text x="450" y="528" text-anchor="middle" font-size="12" font-weight="700" fill="#ffffff">Step C: Rank All 50,000 Candidates by Approximate Score → Keep Top ~1,000</text>

    <!-- Score formula -->
    <text x="40" y="556" font-size="10" fill="#475569">Approximate MaxSim(q, d) = Σ over all query tokens of max( L[qᵢ, c] for surviving centroids c in d )</text>
    <text x="40" y="572" font-size="10" fill="#475569">= 0.87 + 0.79 + 0.82 + <tspan fill="#94a3b8">(sum of 29 more terms)</tspan> = <tspan font-weight="700" fill="#6b21a8">18.4</tspan> for d₇</text>

    <!-- Ranked list -->
    <text x="40" y="598" font-size="10" font-weight="700" fill="#854d0e">Ranked candidate scores (50,000 documents):</text>

    <!-- Top candidates — KEEP -->
    <g font-size="9">
        <rect x="40" y="608" width="160" height="22" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
        <text x="48" y="622" font-weight="700" fill="#166534">1.</text>
        <text x="64" y="622" fill="#166534">d₁₅₅</text>
        <text x="110" y="622" fill="#166534">score = <tspan font-weight="700">22.1</tspan></text>

        <rect x="206" y="608" width="160" height="22" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
        <text x="214" y="622" font-weight="700" fill="#166534">2.</text>
        <text x="230" y="622" fill="#166534">d₇₀₁</text>
        <text x="278" y="622" fill="#166534">score = <tspan font-weight="700">21.7</tspan></text>

        <rect x="372" y="608" width="160" height="22" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
        <text x="380" y="622" font-weight="700" fill="#166534">3.</text>
        <text x="396" y="622" fill="#166534">d₄₂</text>
        <text x="438" y="622" fill="#166534">score = <tspan font-weight="700">20.9</tspan></text>

        <text x="548" y="622" fill="#94a3b8" font-size="10">···</text>

        <rect x="580" y="608" width="170" height="22" rx="4" fill="#dcfce7" stroke="#86efac" stroke-width="1"/>
        <text x="588" y="622" font-weight="700" fill="#166534">47.</text>
        <text x="610" y="622" fill="#166534">d₇</text>
        <text x="648" y="622" fill="#166534">score = <tspan font-weight="700">18.4</tspan></text>

        <text x="766" y="622" fill="#94a3b8" font-size="10">···</text>
    </g>

    <!-- Cutoff line -->
    <g font-size="9">
        <rect x="40" y="636" width="340" height="22" rx="4" fill="#dcfce7" stroke="#86efac" stroke-width="1"/>
        <text x="48" y="650" font-weight="700" fill="#166534">1,000.</text>
        <text x="86" y="650" fill="#166534">d₂₂₄</text>
        <text x="140" y="650" fill="#166534">score = <tspan font-weight="700">12.8</tspan></text>
        <text x="218" y="650" fill="#854d0e" font-weight="700">← cutoff: keep top 1,000</text>
    </g>

    <!-- Dashed cutoff line -->
    <line x1="40" y1="662" x2="860" y2="662" stroke="#dc2626" stroke-width="2" stroke-dasharray="8,4"/>
    <text x="450" y="676" text-anchor="middle" font-size="10" font-weight="700" fill="#dc2626">↓ 49,000 candidates eliminated (98%) — never touch disk ↓</text>

    <!-- Eliminated candidates -->
    <g font-size="9" opacity="0.4">
        <rect x="40" y="682" width="150" height="18" rx="3" fill="#fee2e2" stroke="#fca5a5" stroke-width="0.5"/>
        <text x="48" y="694" fill="#991b1b">1,001. d₃₁₀  score = 12.7</text>
        <rect x="200" y="682" width="150" height="18" rx="3" fill="#fee2e2" stroke="#fca5a5" stroke-width="0.5"/>
        <text x="208" y="694" fill="#991b1b">1,002. d₅₅₁  score = 12.5</text>
        <text x="370" y="694" fill="#94a3b8">···</text>
        <rect x="400" y="682" width="170" height="18" rx="3" fill="#fee2e2" stroke="#fca5a5" stroke-width="0.5"/>
        <text x="408" y="694" fill="#991b1b">50,000. d₉₈₃  score = 1.2</text>
    </g>

    <!-- Key insight box -->
    <rect x="40" y="706" width="830" height="22" rx="5" fill="#faf5ff" stroke="#8b5cf6" stroke-width="1.5"/>
    <text x="455" y="721" text-anchor="middle" font-size="10" fill="#6b21a8">
        <tspan font-weight="700">Key:</tspan> each document's score is computed via table lookups only — no floating-point math, no disk reads.
        Scoring all 50,000 docs takes <tspan font-weight="700">~6 ms</tspan>.
    </text>
</svg>